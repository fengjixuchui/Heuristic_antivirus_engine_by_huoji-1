#include "head.h"
/*
	特别感谢(好像是网上唯一的资料):
	https://github.com/hzqst/unicorn_pe/tree/master/unicorn_pe
*/

void InitGlobalVar() {
	g_global = new globalvar();
	g_pe = new pe_action();
	g_virtual = new virtual_helper();
	g_ssdt = new ssdt_manager();
	g_except = new expect_handle();
}

int main(int argc, char** argv, char** envp)
{
	
	InitGlobalVar();
	//设置模拟参数
	char* main_name = "main.exe";
	sim_process process = {0};
	process.context.m_TebBase = 0x80000; //进程TEB地址
	process.context.m_PebBase = 0x90000; //进程PEB地址
	process.process_data.UniqueProcessId = 0x1337; //进程id
	process.process_data.InheritedFromUniqueProcessId = 0x1337;

	memcpy(process.process_data.ImageFileName, main_name,strlen(main_name));
	//加载到虚拟机内
	//"I:\\对战平台\\CrowAntiCheat\\CrowAntiCheat\\client\\Console_Test\\x64\\Release\\Console_Test.vmp.exe"
	//"Z:\\1.exe"
	//"I:\\对战平台\\CrowAntiCheat\\CrowAntiCheat\\client\\Console_Test\\Release\\Console_Test.exe"
	//"D:\\垃圾项目\\ConsoleApplication1\\Release\\ConsoleApplication1.exe"
	//D:\垃圾项目\ConsoleApplication1\x64\Release\ConsoleApplication1.exe
	int sim_process_index = g_pe->load_pe("I:\\对战平台\\CrowAntiCheat\\CrowAntiCheat\\client\\Console_Test\\x64\\Release\\Console_Test.exe", process);


	//运行模拟
	g_virtual->run(g_global->process[sim_process_index]);
	
	return 0;
}
